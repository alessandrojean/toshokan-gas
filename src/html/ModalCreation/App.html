<script>
  Vue.use(window.vuelidate.default)

  const INITIAL_BOOK = {
    isbn: '',
    title: '',
    authors: '',
    imprint: '',
    size: {
      width: '',
      height: ''
    },
    price: {
      currency: 'R$',
      value: ''
    },
    store: '',
    date8601: '',
    status: 'Lido'
  }

  const app = new Vue({
    el: '#app',
    store: store,
    components: {
      'CreationSearch': CreationSearch,
      'CreationRecord': CreationRecord,
      'CreationImage': CreationImage
    },
    data: function () {
      return {
        book: INITIAL_BOOK,
        coverUrl: '',
        sheet: {},
        errorMessage: '',
        isLoading: false,
        recordHasErrors: false,
        recordIsInvalid: false,
        steps: {
          current: 0,
          initial: 0,
          final: 2
        }
      }
    },
    computed: {
      paginationNextDisabled: function () {
        return this.recordIsInvalid || this.steps.current === this.steps.final
      },
      ...Vuex.mapGetters('settings', ['cblQueryKey'])
    },
    methods: {
      handleCancelClick: function () {
        google.script.host.close()
      },
      handleFillInfoClick: function () {
        this.isLoading = true

        const { title, authors, imprint } = this.$refs.creationRecord.internBook

        google.script.run
          .withSuccessHandler(this.handleFillInfoSuccess.bind(this))
          .withFailureHandler(this.showError.bind(this))
          .searchOccurrencies({ title, authors, imprint })
      },
      handleFillInfoSuccess: function (sheetResult) {
        this.isLoading = false

        const internBook = this.$refs.creationRecord.internBook

        this.sheet = Object.assign({}, this.sheet, sheetResult || {})
        this.book = Object.assign({}, this.book, {
          ...internBook,
          title: sheetResult ? sheetResult.title : internBook.title,
          authors: sheetResult ? sheetResult.authors : internBook.authors,
          imprint: sheetResult? sheetResult.imprint : internBook.imprint,
          price: sheetResult ? sheetResult.price : INITIAL_BOOK.price,
          size: sheetResult ? sheetResult.size : INITIAL_BOOK.size,
        })
      },
      handleFormSubmit: function (event) {
        if (this.recordHasErrors || this.steps.current !== this.steps.final) {
          return
        }

        this.isLoading = true

        const rowBefore = this.sheet.rowBefore

        const book = this.book
        const date = book.date8601
        const rowData = [
          book.isbn,
          book.title,
          book.authors,
          book.imprint,
          book.size.width + ' Ã— ' + book.size.height,
          book.status,
          book.price.currency + ' ' + book.price.value,
          book.store,
          date.length ? date.split('-').reverse().join('/'): date
        ]

        const additional = {
          coverUrl: this.coverUrl
        }

        google.script.run
          .withSuccessHandler(this.handleFormSubmitSuccess.bind(this))
          .withFailureHandler(this.showError.bind(this))
          .createEntryRow(rowData, additional, rowBefore)
      },
      handleFormSubmitSuccess: function () {
        google.script.host.close()
      },
      handleImageFetch: function (fetching) {
        this.isLoading = fetching
      },
      handlePaginationNext: function () {
        if (this.steps.current === 0) {
          this.coverUrl = ''
          this.recordHasErrors = false
          this.recordIsInvalid = false
        } else if (this.steps.current === 1) {
          const internBook = this.$refs.creationRecord.internBook
          this.book = Object.assign({}, this.book, internBook, {
            size: { ...internBook.size },
            price: { ...internBook.price }
          })
        }

        this.steps.current = this.steps.current + 1
      },
      handlePaginationPrevious: function () {
        this.steps.current = this.steps.current - 1

        if (this.steps.current == 0) {
          this.recordHasErrors = false
          this.recordIsInvalid = false
          this.coverUrl = ''
          this.book = Object.assign({}, this.book, INITIAL_BOOK, {
            size: { ...INITIAL_BOOK.size },
            price: { ...INITIAL_BOOK.price }
          })
          this.sheet = Object.assign({}, this.sheet, {})
        }
      },
      handleRecordValidationError: function (hasErrors) {
        this.recordHasErrors = hasErrors
      },
      handleRecordValidationInvalid: function (isInvalid) {
        this.recordIsInvalid = isInvalid
      },
      handleSearchError: function (error) {
        this.showError(error)
      },
      handleSearchFetch: function () {
        this.isLoading = true
      },
      handleSearchHit: function ({ bookResult, sheetResult }) {
        this.isLoading = false

        this.book = Object.assign({}, this.book, {
          ...bookResult,
          price: sheetResult ? sheetResult.price : INITIAL_BOOK.price,
          size: sheetResult ? sheetResult.size : INITIAL_BOOK.size
        })
        this.sheet = Object.assign({}, this.sheet, sheetResult || {})

        this.steps.current = this.steps.current + 1
      },
      handleSearchManual: function () {
        this.book = Object.assign({}, this.book, INITIAL_BOOK)
        this.sheet = Object.assign({}, this.sheet, {})
        this.steps.current = this.steps.current + 1
      },
      showError: function (error) {
        this.isLoading = false
        this.errorMessage = error.message || error
      }
    },
    created: function () {
      if (!this.cblQueryKey.length) {
        this.steps.current = 1
        this.steps.initial = 1
      }
    }
  })
</script>
