<script>    
  const $ = document.querySelector.bind(document)
  const $$ = document.querySelectorAll.bind(document)
  NodeList.prototype.forEach = Array.prototype.forEach
  NodeList.prototype.map = Array.prototype.map
  
  $('form').addEventListener('submit', handleFormSubmit)
  $('form').addEventListener('keypress', event => event.keyCode != 13)
  
  document.addEventListener('DOMContentLoaded', () => {
    showProperties()
    setupMenu()
  })
  
  function showProperties() {
    const properties = JSON.parse($('input[name=properties-json]').value)
    
    for (const [key, value] of Object.entries(properties)) {
      const currentScope = key.toUpperCase() + '_'
      for (const [scopeKey, scopeValue] of Object.entries(value)) {
        const propertyInput = $('[name=' + currentScope + scopeKey + ']')
        
        if (propertyInput) {
          if (propertyInput.type === 'checkbox') {
            propertyInput.checked = (scopeValue === 'true')
          } else {
            propertyInput.value = scopeValue
          }
        }
      }
    }
  }
  
  function setupMenu() {
    $$('aside.menu li a[data-target]').forEach(m => m.addEventListener('click', handleMenuChange))
  }
  
  function handleMenuChange(event) {      
    const currentActive = $('aside.menu li a.is-active')
    currentActive.classList.remove('is-active')
    $('#' + currentActive.dataset.target).classList.add('is-hidden')
    
    event.target.classList.add('is-active')
    $('#' + event.target.dataset.target).classList.remove('is-hidden')
  }
  
  function startLoading() {
    $('#loader-general').classList.add('is-active')
  }
  
  function finishLoading() {
    $('#loader-general').classList.remove('is-active')
  }
  
  function showError(error) {
    finishLoading()
    $('#form-content').classList.add('is-hidden')
    $('#message-danger').classList.remove('is-hidden')
    $('#message-danger .message-body').innerHTML = error
  }
  
  function handleFormSubmit(event) {
    event.preventDefault()
    const formData = new FormData(event.target)
    
    startLoading()
    
    const properties = {}
    
    const checkboxes = $$('input[type=checkbox]').map(c => [c.name, c.checked])
    const entries = Array.from(formData.entries()).concat(checkboxes)
    
    for (const [key, value] of entries) {
      if (!key.match(/[A-Z0-9_]+/g)) {
        continue
      }
      
      const paths = key.split('_')
      const scope = paths[0].toLowerCase()
      const scopeKey = paths.slice(1).join('_')
      
      if (!properties[scope]) {
        properties[scope] = {}
      }
      
      properties[scope][scopeKey] = value
    }        
    
    google.script.run
      .withSuccessHandler(onUpdateSettingsSuccess)
      .withFailureHandler(onUpdateSettingsFailure)
      .updateSettings(properties)
  }
  
  function onUpdateSettingsFailure(error) {
    showError(error.message)
  }
  
  function onUpdateSettingsSuccess() {
    google.script.host.close()
  }
</script>
